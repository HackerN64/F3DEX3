<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>F3DEX3: F3DEX3</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">F3DEX3
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_README.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">F3DEX3</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a> Modern microcode for N64 romhacks. Will make you want to finally ditch HLE. Heavily modified version of F3DEX2, partially rewritten from scratch.</p>
<p><b>F3DEX3 is in alpha. It is not guaranteed to be bug-free, and updates may bring breaking changes.</b></p>
<p><a href="https://hackern64.github.io/F3DEX3/">View the documentation here</a> (or just look through the docs folder).</p>
<p><a href="https://www.youtube.com/playlist?list=PLU2OUGtyQi6QswDQOXWIMaYFUcgQ9Psvm">Sauraen's videos on F3DEX3</a></p>
<h1><a class="anchor" id="autotoc_md1"></a>
Features</h1>
<h2><a class="anchor" id="autotoc_md2"></a>
New visual features</h2>
<ul>
<li>New geometry mode bit <code>G_PACKED_NORMALS</code> enables <b>simultaneous vertex colors and normals/lighting on the same mesh</b>, by encoding the normals in the unused 2 bytes of each vertex using a variant of <a href="https://knarkowicz.wordpress.com/2014/04/16/octahedron-normal-vector-encoding/">octahedral encoding</a>. The normals are effectively as precise as with the vanilla method of replacing vertex RGB with normal XYZ.</li>
<li>New geometry mode bit <code>G_AMBOCCLUSION</code> enables <b>ambient occlusion</b> for opaque materials. Paint the shadow map into the vertex alpha channel; separate factors (set with <code>SPAmbOcclusion</code>) control how much this affects the ambient light, all directional lights, and all point lights.</li>
<li>New geometry mode bit <code>G_LIGHTTOALPHA</code> moves light intensity (maximum of R, G, and B of what would normally be the shade color after lighting) to shade alpha. Then, if <code>G_PACKED_NORMALS</code> is also enabled, the shade RGB is set to the vertex RGB. Together with alpha compare and some special display lists from fast64 which draw triangles two or more times with different CC settings, this enables <b>cel shading</b>. Besides cel shading, <code>G_LIGHTTOALPHA</code> can also be used for <a href="https://renderu.com/en/spookyiluhablog/post/23631">bump mapping</a> or other unusual CC effects (e.g. texture minus vertex color times lighting).</li>
<li>New geometry mode bits <code>G_FRESNEL_COLOR</code> or <code>G_FRESNEL_ALPHA</code> enable <b>Fresnel</b>. The dot product between a vertex normal and the vector from the vertex to the camera is computed; this is then scaled and offset with settable factors. The resulting value is then stored to shade color or shade alpha. This is useful for:<ul>
<li>making surfaces like water and glass fade between transparent when viewed straight-on and opaque when viewed at a large angle</li>
<li>applying a fake "outline" around the border of meshes</li>
<li>the N64 bump mapping implementation mentioned above</li>
</ul>
</li>
<li>New geometry mode bit <code>G_LIGHTING_SPECULAR</code> changes lighting computation from diffuse to <b>specular</b>. If enabled, the vertex normal for lighting is replaced with the reflection of the vertex-to-camera vector over the vertex normal. Also, a new size value for each light controls how large the light reflection appears to be. This technique is lower fidelity in some ways than the vanilla <code>hilite</code> system, as it is per-vertex rather than per-pixel, but it allows the material to be textured normally. Plus, it supports all scene lights (including point) with different dynamic colors, whereas the vanilla system supports up to two directional lights and more than one dynamic color is difficult.</li>
<li>New geometry mode bits <code>G_ATTROFFSET_ST_ENABLE</code> and <code>G_ATTROFFSET_Z_ENABLE</code> apply settable offsets to vertex ST (<code>SPAttrOffsetST</code>) and/or Z (<code>SPAttrOffsetZ</code>) values. These offsets are applied after their respective scales. For Z, this enables a method of drawing coplanar surfaces like decals but <b>without the Z fighting</b> which can happen with the RDP's native decal mode. For ST, this enables <b>UV scrolling</b> without CPU intervention.</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Performance improvements</h2>
<ul>
<li><b>56 verts</b> can fit into DMEM at once, up from 32 verts in F3DEX2, and only 13% below the 64 verts of reject microcodes. This reduces DRAM traffic and RSP time as fewer verts have to be reloaded and re-transformed, and also makes display lists shorter.</li>
<li>New <b>occlusion plane</b> system allows the placement of a 3D quadrilateral where objects behind this plane in screen space are culled. This can dramatically improve RDP performance by reducing overdraw in scenes with walls in the middle, such as a city or an indoor scene.</li>
<li>If a material display list being drawn is the same as the last material, the texture loads in the material are skipped (the second time). This effectively results in <b>auto-batched rendering</b> of repeated objects, as long as each only uses one material. This system supports multitexture and all types of loads. If this system incorrectly culls supposedly repeated texture loads which actually differ due to segment manipulation, you can locally disable it using the new <code>SPDontSkipTexLoadsAcross</code> command.</li>
<li>New <code>SPTriangleStrip</code> and <code>SPTriangleFan</code> commands <b>pack up to 5 tris</b> into one 64-bit GBI command (up from 2 tris in F3DEX2). In any given object, most tris can be drawn with these commands, with only a few at the end drawn with <code>SP2Triangles</code> or <code>SP1Triangle</code>. So, this cuts the triangle portion of display lists roughly in half, saving DRAM traffic and ROM space.</li>
<li>New <code>SPAlphaCompareCull</code> command enables culling of triangles whose computed shade alpha values are all below or above a settable threshold. This <b>substantially reduces the performance penalty of cel shading</b>&ndash;only tris which "straddle" the cel threshold are drawn twice, the others are only drawn once.</li>
<li>A new "hints" system encodes the expected size of the target display list into call, branch, and return DL commands. This allows only the needed number of DL commands in the next DL to be fetched, rather than always fetching full buffers, <b>saving some DRAM traffic</b> (maybe around 100 us per frame). The bits used for this are ignored by HLE.</li>
<li>Segment addresses are now resolved relative to other segments (feature by Tharo). This enables a strategy for <b>skipping repeated material DLs</b>: call a segment to run the material, remap the segment in the material to a display list that immediately returns, and so if the material is called again it won't run.</li>
<li>New <code>SPMemset</code> command fills a specified RDRAM region with a repeated 16-bit value. This can be used for clearing the Z buffer or filling the framebuffer or the letterbox with a solid color <b>faster than the RDP can in fill mode</b>. Practical performance may vary due to scheduling constraints.</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Miscellaneous</h2>
<ul>
<li><b>Point lighting</b> has been redesigned. The appearance when a light is close to an object has been improved. Fixed a bug in F3DEX2/ZEX point lighting where a Z component was accidentally doubled in the point lighting calculations. The quadratic point light attenuation factor is now an E3M5 floating-point number. The performance penalty for using large numbers of point lights has been reduced.</li>
<li>Maximum number of directional / point <b>lights raised from 7 to 9</b>. Minimum number of directional / point lights lowered from 1 to 0 (F3DEX2 required at least one). Also supports loading all lights in one DMA transfer (<code>SPSetLights</code>), rather than one per light.</li>
<li>New <code>SPLightToRDP</code> family of commands (e.g. <code>SPLightToPrimColor</code>) writes a selectable RDP command (e.g. <code>DPSetPrimColor</code>) with the RGB color of a selectable light (any including ambient). The alpha channel and any other parameters are encoded in the command. With some limitations, this allows the tint colors of cel shading to <b>match scene lighting</b> with no code intervention. Also useful for other lighting-dependent effects.</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
Profiling</h2>
<p>F3DEX3 introduces a suite of performance profiling capabilities. These take the form of performance counters, which report cycle counts for various operations or the number of items processed of a given type. There are a total of 21 performance counters across multiple microcode versions. See the Profiling section below.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Credits</h1>
<p>F3DEX3 modifications from F3DEX2 are by Sauraen and are dedicated to the public domain. <code>cpu/</code> C code is entirely by Sauraen and also dedicated to the public domain.</p>
<p>If you use F3DEX3 in a romhack, please credit "F3DEX3 Microcode - Sauraen" in your project's in-game Staff Roll or wherever other contributors to your project are credited.</p>
<p>Other contributors:</p><ul>
<li>Wiseguy: large chunk of F3DEX2 disassembly documentation and first version of build system</li>
<li>Tharo: relative segment resolution feature, other feature discussions</li>
<li>Kaze Emanuar: several feature suggestions, testing</li>
<li>thecozies: Fresnel feature suggestion</li>
<li>Rasky: memset feature suggestion</li>
<li>coco875: Doxygen / GitHub Pages setup</li>
<li>neoshaman: feature discussions </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
