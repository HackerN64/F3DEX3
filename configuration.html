<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>F3DEX3: Microcode Configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">F3DEX3
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('configuration.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Microcode Configuration</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md16"></a>
Microcode Configuration</h1>
<p>There are several selectable configuration settings when building F3DEX3, which can be enabled in any combination. With a couple minor exceptions, none of these settings affect the GBI&ndash;in fact, you can swap between the microcode versions on a per-frame basis if you build multiple versions into your romhack.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
No Occlusion Plane (NOC)</h2>
<p>If you are not using the occlusion plane feature in your romhack, you can use this configuration, which removes the computation of the occlusion plane in the vertex processing pipeline, saving some RSP time.</p>
<p>If you care about performance, please do consider using the occlusion plane! RDP time savings of 3-4 ms are common in scenes with reasonable occlusion planes, and even saving a third of the total RDP time can sometimes happen. Furthermore, when even a small percentage of the total triangles drawn are occluded, not only is RDP time saved (which is the point), but RSP time is also saved from not having to process those tris. This can offset the extra RSP time for computing the occlusion plane for all vertices.</p>
<p>You can also build both the NOC and base microcodes into your ROM and switch between them on a per-frame basis. If there is no occlusion plane active or the best occlusion plane candidate would be very small on screen, you can use the NOC microcode and save RSP time. If there is a significant occlusion plane, you can use the base microcode and reduce the RDP time. You could also determine which version to use on the profiling results from the previous frame: if the RSP is the bottleneck (e.g. the RDP <code>CLK - CMD</code> is high), use the NOC version, and otherwise use the base version.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
Legacy Vertex Pipeline (LVP)</h2>
<p>The primary tradeoff for all the new lighting features in F3DEX3 is increased RSP time for vertex processing. The base version of F3DEX3 takes about <b>2-2.5x</b> more RSP time for vertex processing than F3DEX2 (see Performance Results section below), assuming no lighting or directional lights only. You should use the F3DEX3 performance counters (see below) to determine whether your game is usually RSP or RDP bound.</p>
<p>If your game is usually RDP bound&ndash;like OoT&ndash;this generally will not affect the game's overall framerate, so you should stick with base F3DEX3:</p><ul>
<li>The increased time only applies to vertex processing, not triangle processing or other miscellaneous microcode tasks. So the total RSP cycles spent doing useful work during the frame is only modestly increased.</li>
<li>The increase in time is only RSP cycles; there is no additional memory traffic, so the RDP time is not directly affected.</li>
<li>In scenes which are complex enough to fill the RSP-&gt;RDP FIFO in DRAM, the RSP usually spends a significant fraction of time waiting for the FIFO to not be full, as revealed by the performance counters. In these cases, slower vertex processing simply means less time spent waiting, and little to no change in total RSP time.</li>
<li>When the FIFO does not fill up, usually the RSP takes significantly less time during the frame compared to the RDP, so increased RSP time usually does not affect the overall framerate.</li>
</ul>
<p>However, for RSP bound or extremely optimized (Kaze Emanuar) games, base F3DEX3 can become a bottleneck, so the Legacy Vertex Pipeline (LVP) configuration has been introduced.</p>
<p>This configuration replaces F3DEX3's native vertex and lighting code with a faster version based on the same algorithms as F3DEX2. This removes:</p><ul>
<li>Point lighting</li>
<li>F3DEX3 lighting features: packed normals, ambient occlusion, light-to-alpha (cel shading), Fresnel, and specular lighting</li>
<li>ST attribute offsets</li>
</ul>
<p>However, it retains all other F3DEX3 features:</p><ul>
<li>56 verts, 9 directional lights</li>
<li>Occlusion plane (optional with NOC configuration)</li>
<li>All features not related to vertex/lighting: auto-batched rendering, packed 5 triangles commands, hints system, etc.</li>
</ul>
<p>With both LVP and NOC enabled, F3DEX3 is faster on the RSP than F3DEX2 (see <a class="el" href="performance.html">Performance Results</a>).</p>
<h2><a class="anchor" id="autotoc_md19"></a>
Profiling</h2>
<p>As mentioned above, F3DEX3 includes many performance counters. There are far too many counters for a single microcode to maintain, so multiple configurations of the microcode can be built, each containing a different set of performance counters. These can be swapped while the game is running so the full set of counters can be effectively accessed over multiple frames.</p>
<p>There are a total of 21 performance counters, including:</p><ul>
<li>Counts of vertices, triangles, rectangles, matrices, DL commands, etc.</li>
<li>Times the microcode was processing vertices, processing triangles, stalled because the RDP FIFO in DMEM was full, and stalled waiting for DMAs to finish</li>
<li>A counter enabling a rough measurement of how long the RDP was stalled waiting for RDRAM for I/O to the framebuffer / Z buffer</li>
</ul>
<p>The default configuration of F3DEX3 provides a few of the most basic counters. The additional profiling configurations, called A, B, and C (for example <code>F3DEX3_BrZ_PA</code>), provide additional counters, but have two default features removed to make space for the extra profiling. These two features were selected because their removal does not affect the RDP render time.</p><ul>
<li>The <code>SPLightToRDP</code> commands are removed (they become no-ops)</li>
<li>Flat shading mode, i.e. <code>!G_SHADING_SMOOTH</code>, is removed (all tris are smooth)</li>
</ul>
<h2><a class="anchor" id="autotoc_md20"></a>
Branch Depth Instruction (<code>BrZ</code> / <code>BrW</code>)</h2>
<p>Use <code>BrZ</code> if the microcode is replacing F3DEX2 or an earlier F3D version (i.e. SM64), or <code>BrW</code> if the microcode is replacing F3DZEX (i.e. OoT or MM). This controls whether <code>SPBranchLessZ*</code> uses the vertex's W coordinate or screen Z coordinate.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Debug Normals (<code>dbgN</code>)</h2>
<p>Debug Normals has been moved out of the Makefile as it is not a microcode version intended to be shipped. It can still be enabled by changing <code>CFG_DEBUG_NORMALS equ 0</code> to <code>1</code> in the microcode.</p>
<p>To help debug lighting issues when integrating F3DEX3 into your romhack, this feature causes the vertex colors of any material with lighting enabled to be set to the transformed, normalized world space normals. The X, Y, and Z components map to R, G, and B, with each dimension's conceptual (-1.0 ... 1.0) range mapped to (0 ... 255). This is not compatible with LVP as world space normals do not exist in that pipeline. This also breaks vertex alpha and texgen / lookat.</p>
<p>Some ways to use this for debugging are:</p><ul>
<li>If the normals have obvious problems (e.g. flickering, or not changing smoothly as the object rotates / animates), there is likely a problem with the model space normals or the M matrix. Conversely, if there is a problem with the standard lighting results (e.g. flickering) but the normals don't have this problem, the problem is likely in the lighting data.</li>
<li>Check that the colors don't change based on the camera position, but DO change as the object rotates, so that the same side of an object in world space is always the same color.</li>
<li>Make a simple object like an octahedron or sphere, view it in game, and check that the normals are correct. A normal pointing along +X would be (1.0, 0.0, 0.0), meaning (255, 128, 128) or pink. A normal pointing along -X would be (-1.0, 0.0, 0.0), meaning (0, 128, 128) or dark cyan. Bright, fully saturated colors like green (0, 255, 0), yellow (255, 255, 0), or black should never appear as these would correspond to impossibly long normals.</li>
<li>Make the same object (octahedron is easiest in this case) with vertex colors which match what the normals should be, and compare them. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="md_docs_2documentation.html">Documentation</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
